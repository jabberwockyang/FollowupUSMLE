# followup Analysis


## followup question generation
1. GPT4 generation
    - FollowupGeneration/followup_generation.py

        - one-shot prompt 

            ```python
            # system_prompt = 'You are ChatGPT, a large language model trained by OpenAI, based on the GPT-4 architecture. Knowledge cutoff: 2022-01 Current date: 2023-11-07'
            example_text="We are evaluating the medical ability of an LLM through USMLE test. For the questions that the LLM got wrong, we want to **extract** the basic knowledge and comprehensive application capabilities tested by the USMLE questions, and ask the LLM separately to find out what aspects of the LLM's lack of knowledge or ability caused them to get the questions wrong.**The following is an example**.<br> **input:**'A 26-year-old man comes to the office because of a 1-week history of increased urinary frequency accompanied by excessive thirst. He says he has been urinating hourly. Physical examination shows no abnormalities. Serum chemistry studies are within the reference ranges. Urine osmolality is 50 mOsmol/kg H2O. After administration of ADH (vasopressin), his urine osmolality is within the reference range. The most likely cause of this patient's symptoms is dysfunction of which of the following structures?  <br>A. Anterior pituitary gland  <br>B. Bowman capsule  <br>C. Glomerulus  <br>D. Hypophysial portal system  <br>E. Loop of Henle  <br>F. Supraoptic nucleus '<br>**output**:{'question_for_basic_knowledge':[{'question':'How to diagnse diabetes insipidus', 'classification':'endocrinology'},{'question':'How to distinguish Central diabetes insipidus and renal diabetes insipidus','classification':'endocrinology'},{'question':'What is the mechanism of diabetes insipidus','classification':'endocrinology'}],'question_for_interpretation_and_association':[{'question':'What is the diagnosis of the patient','classification':'clinical'},{'question':'Which type of diabetes insipidus does the patient have','classification':'clinical'},{'question':'What is most likely causing the symptoms of the patient','classification':'clinical'}]}"
            prompt=f"{example_text}<br>**input**:'{test_text}'<br>**output**:"
                completion = openai.ChatCompletion.create(
                model="gpt-4-0613",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": prompt}],)
            ```

        - the expected json format GPT4 should return is as follow
            
            however, the actual output may not be exactly the same as the expected format, so you may need to do some post-processing to get the expected format.
            
            In our experience, it can be resolved by extraction with regular expression and multiple queries until the expected format is obtained. Only a few cases need multiple queries.

            ```json
            {
                "question_for_basic_knowledge":[
                    {"question":"q1",
                    "classification":""},
                    {"question":"q2",
                    "classification":""},
                    {"question":"q3",
                    "classification":""},
                ],
                "question_for_interpretation_and_association":[
                    {"question":"q4",
                    "classification":""},
                    {"question":"q5",
                    "classification":""},
                    {"question":"q6",
                    "classification":""},
                ]
            }

            ```
                    
        - label optimization (UNDER DEVELOPMENT)

            - classification standardization: classification labels generated by GPT4 can involve many similar tags. previously the process is done by manual proceeding. 

            - involve_diagnosis: bool indicating whether the followup question require a diagnostic conclusion. previously the process is done by simple search of 'diagno' to match all words related with diagnosis  


        - the final question list should be in format like this and will be used as input of the FollowupTest process

            ```json
                [{
                    "question": "What happens to these components when an individual changes position from standing to supine?",
                    "key": "question_for_basic_knowledge",
                    "classification": "physiology",
                    "answer": "not answered",
                    "annotate": "not annotated",
                    "involve_diagnosis": false, 
                    "usmle_test": "25. A healthy 30-year-old woman participates in a study of the relationship between cardiovascular function and posture. Placed in a room with a comfortable temperature (72Â°F) and humidity (40%), she moves from a standing to a supine position. Which of the following sets of changes is most likely in the reflex control of this woman's cardiovascular system?\nA. Carotid Sinus Baroreceptor Activity, Atrial Stretch Receptor Activity, and Vagal Efferent Activity to the Heart increase\nB. Carotid Sinus Baroreceptor Activity and Atrial Stretch Receptor Activity increase, while Vagal Efferent Activity to the Heart decrease\nC. Carotid Sinus Baroreceptor Activity and Vagal Efferent Activity to the Heart increase, while Atrial Stretch Receptor Activity decrease\nD. Carotid Sinus Baroreceptor Activity increase, while Atrial Stretch Receptor Activity and Vagal Efferent Activity to the Heart decrease\nE. Carotid Sinus Baroreceptor Activity decrease, while Atrial Stretch Receptor Activity and Vagal Efferent Activity to the Heart increase\nF. Carotid Sinus Baroreceptor Activity and Vagal Efferent Activity to the Heart  decrease, while Atrial Stretch Receptor Activity increase\nG. Carotid Sinus Baroreceptor Activity and Atrial Stretch Receptor Activity decrease, while Vagal Efferent Activity to the Heart increase\nH. Carotid Sinus Baroreceptor Activity, Atrial Stretch Receptor Activity, and Vagal Efferent Activity to the Heart decrease"
                },
                {
                    "question":""
                }
                ]

            ```



## followup testing
 
- FollowupTest/5vote.py

    - 5vote is a method to evaluate the performance of the LLM in answering USMLE questions.

    - options shuffling and multiple prompt templates are used to reduce the bias of the LLMs.

    - the result of 5votes and the followup performance will be analyzed integratively to evaluate the LLM's performance in medical knowledge and clinical reasoning.

    - use original USMLE questions as input

    - output is a jsonl with complete response, for the downstream analysis only the calculated performance will be used
        

- FollowupTest/get_answer_annotation.py

    - get the answer from LLM tobe tested and annotation from GPT4 for the followup question list generated by GPT4 previously

    - use FollowupGeneration/followup_question_list.json as input

    - output 2 files in the test folder:

        FollowupTest/followup_question_list_answered.jsonl

        FollowupTest/followup_question_list_annotated.jsonl

## followup result analysis

1. standard data format for analysis:

    - if not in standard format as below, please formatting the file and place them in the folder for each checkpoints

    - followup performace
        ```json
        {
            "usmle_test": "A 31-year-old woman, gravida 3, para 2, who is at 32 weeks' gestation, is admitted to the hospital because of a 1-week history of progressive dyspnea and wheezing. She says her heart is \"racing\" and she is coughing up a small amount of blood-streaked sputum. Medical history is significant for hypothyroidism, for which she takes levothyroxine. An intravenous catheter is placed. Vital signs are temperature 36.9\u00b0C (98.4\u00b0F), pulse 132/min, respirations 32/min, and blood pressure 135/78 mm Hg. Pulse oximetry on 100% oxygen via nasal cannula shows an oxygen saturation of 92%. Auscultation of the lungs discloses decreased breath sounds at the bases with expiratory crackles bilaterally. Cardiac examination discloses an irregularly irregular rhythm, an indistinct point of maximal impulse, and a loud S1. A grade 3/6, low-pitched, diastolic, rumbling murmur is audible at the apex; a distinct snapping sound precedes the murmur. Fetal heart rate is 144/min. Which of the following is the most likely cause of the findings in this patient?\n\n\nA. Atrial septal defect with development of pulmonary hypertension\nB. Chronic mitral regurgitation secondary to rheumatic heart disease\nC. Coarctation of the aorta\nD. Congenital aortic stenosis\nE. Mitral stenosis complicated by atrial fibrillation",
            "follow_up_q": [
                {
                    "question": "What are the symptoms and signs of mitral stenosis?",
                    "classification": "cardiology",
                    "answer": "The symptoms of mitral stenosis include dyspnea on exertion, orthopnea, paroxysmal nocturnal dyspnea, and hemoptysis. Physical examination may reveal a diastolic rumbling murmur best heard at the apex with radiation to the axilla, an opening snap, and signs of right heart failure such as jugular venous distention, hepatomegaly, and peripheral edema.",
                    "annotate": true,
                    "involve_diagnosis": false,
                    "key": "question_for_basic_knowledge"
                },
                {
                    "question": "How does rheumatic heart disease cause mitral stenosis and its clinical manifestations?",
                    "classification": "cardiology",
                    "answer": "Rheumatic heart disease is a complication of rheumatic fever, which is caused by group A streptococcal pharyngitis. The inflammation and scarring that occur in rheumatic fever can affect the heart, leading to mitral stenosis. This is the most common valvular lesion seen in rheumatic heart disease. The mitral valve is affected because it is the first valve to close after the left ventricle contracts, and the inflammation and scarring can cause the valve leaflets to thicken and become less mobile, leading to stenosis. This stenosis can cause a decrease in the volume of blood that can flow from the left atrium to the left ventricle, leading to increased left atrial pressure. This increased pressure can cause pulmonary congestion and pulmonary hypertension, which can lead to symptoms such as dyspnea and wheezing. The irregularly irregular rhythm and loud S1 are due to the irregularly irregular atrial fibrillation that often occurs in mitral stenosis. The diastolic, rumbling murmur at the apex is characteristic of mitral stenosis. The snapping sound that precedes the murmur is due to the opening of the stenotic mitral valve.",
                    "annotate": true,
                    "involve_diagnosis": false,
                    "key": "question_for_basic_knowledge"
                },
                {
                    "question": "How is atrial fibrillation connected to mitral stenosis?",
                    "classification": "cardiology",
                    "answer": "Atrial fibrillation is a common complication of mitral stenosis. In mitral stenosis, the mitral valve becomes narrowed, which can lead to increased pressure in the left atrium. This pressure can cause the left atrium to dilate and become enlarged, which can in turn lead to atrial fibrillation. The enlarged left atrium can cause the electrical signals that control the heart's rhythm to become disorganized, leading to an irregular heartbeat.",
                    "annotate": true,
                    "involve_diagnosis": false,
                    "key": "question_for_basic_knowledge"
                },
                {
                    "question": "What is the probable diagnosis for the patient based on her clinical manifestations?",
                    "classification": "clinical",
                    "answer": "The answer is [E]\n",
                    "annotate": true,
                    "involve_diagnosis": true,
                    "key": "question_for_interpretation_and_association"
                },
                {
                    "question": "How does this heart condition relate to the patient's symptoms such as dyspnea and wheezing?",
                    "classification": "clinical",
                    "answer": "The patient's symptoms of dyspnea and wheezing are likely related to the heart condition in this case, which is mitral stenosis complicated by atrial fibrillation. Mitral stenosis can lead to pulmonary congestion and edema, which can cause dyspnea and wheezing. The atrial fibrillation can also contribute to these symptoms by causing an irregular heart rhythm and decreased cardiac output. The diastolic, rumbling murmur at the apex and the snapping sound preceding the murmur are characteristic of mitral stenosis.",
                    "annotate": true,
                    "involve_diagnosis": false,
                    "key": "question_for_interpretation_and_association"
                },
                {
                    "question": "What other symptoms and signs can be expected from a patient with mitral stenosis complicated by atrial fibrillation?",
                    "classification": "clinical",
                    "answer": "Other symptoms and signs that can be expected in a patient with mitral stenosis complicated by atrial fibrillation include palpitations, fatigue, and dyspnea on exertion. In severe cases, patients may also experience chest pain, syncope, and hemoptysis. Physical examination may reveal a loud S1, a diastolic rumble at the apex, and signs of right heart failure such as jugular venous distension, hepatomegaly, and peripheral edema.",
                    "annotate": true,
                    "involve_diagnosis": false,
                    "key": "question_for_interpretation_and_association"
                }
            ]
        }
            
        
        ```

    - 5vote performace: csv with these 2 columns ['usmle_test','performance']

2. analysis script:

    - FollowupAnalysis/FollowUpAnalysis.ipynb